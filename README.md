
# Микросервис для получения координат земельного участка по кадастровому номеру

## Описание решения

Данный проект реализует микросервис, который по кадастровому номеру возвращает координаты участка. 

Решение построено по архитектуре с полной асинхронной разделённостью веб-сервера и обработчика задачи через файловую очередь.

---

## Архитектура

Проект состоит из трёх основных компонентов:

1. **API-сервер (`app.py`)**
   - Лёгковесный веб-сервер на FastAPI
   - Принимает HTTP-запросы и создаёт файлы задач в общей папке
   - Ожидает появления файла-результата и возвращает ответ клиенту

2. **Воркер (`worker.py`)**
   - Постоянно работающий скрипт
   - Сканирует общую папку на наличие новых задач
   - Для каждой задачи запускает внешнюю библиотеку `rosreestr2coord` через subprocess
   - Читает файл с результатами и помещает их в папку с результатами для API-сервера

3. **Файловая очередь (`rosreestr_queue/`)**
   - Общая папка для обмена файлами между сервером и воркером
   - Минимальная и надёжная схема межпроцессного взаимодействия

---

## Рабочий процесс

1. Клиент отправляет запрос GET `/coordinates/{cadastral_number}`
2. Сервер `app.py` создаёт `.task` файл с кадастровым номером
3. Воркер `worker.py` находит задачу, запускает `rosreestr2coord` и ждёт
4. `rosreestr2coord` создаёт файл с координатами в папке `output/geojson`
5. Воркер читает результат, создаёт `.result` файл
6. API-сервер читает `.result`, отправляет данные клиенту и очищает очередь

---

## Технологии

- Python 3.x
- FastAPI
- rosreestr2coord (вызов через subprocess)
- Асинхронное программирование (asyncio)

---

## Запуск проекта

Для корректной работы проекта необходимо:

- Запустить `worker.py` в отдельном окне терминала
- Запустить `app.py` (например, через `uvicorn` или VS Code отладчик)
- Делать параметры запроса на API-сервер

---

## Примечание

- Используется файловая очередь для избежания блокировок, связанных с subprocess и async в Windows
- `rosreestr2coord` сама создаёт файлы с результатами по умолчанию в `output/geojson`
- Для стабильности рекомендуется настроить и использовать API-ключ от сервисов распознавания капчи, если это необходимо

## Запуск и использование
1. Установка зависимостей
`pip install -r requirements.txt`

2. Запуск системы
Для работы требуется два отдельных терминала.

**Терминал 1: Запуск Воркера**

Активируйте виртуальное окружение и запустите воркер. Он будет работать в фоне и ждать задач.

`python worker.py`

**Терминал 2: Запуск API-сервера**

Активируйте виртуальное окружение и запустите сервер.

## Для обычной работы:
`uvicorn app:app --host 0.0.0.0 --port 8000`

## Для отладки в VS Code:
## Просто нажмите F5 (будет использована конфигурация из .vscode/launch.json)

3. Отправка запроса

Отправьте GET-запрос на API, используя браузер, curl или Postman:

`GET http://localhost:8000/coordinates/50:04:0040414:139`

Ожидаемый успешный ответ:

```json
[
  37.504573324330195,
  56.175435057633386
]